<!DOCTYPE html>
<html lang="ru">
	<head>
		<meta charset="UTF-8" />
		<title>Админ-панель | Бетон-30</title>
		<style>
			body {
				font-family: sans-serif;
				background: #f4f4f4;
				padding: 30px;
			}
			.login-box {
				background: white;
				padding: 20px;
				max-width: 400px;
				margin: 50px auto;
				border-radius: 10px;
				box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
			}
			table {
				width: 100%;
				border-collapse: collapse;
				margin-top: 30px;
				background: white;
				box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
			}
			th,
			td {
				padding: 10px;
				border: 1px solid #ccc;
				text-align: left;
			}
			th {
				background: #333;
				color: white;
			}
			h2 {
				margin-bottom: 20px;
			}
			.action-btn {
				padding: 5px 10px;
				margin: 0 5px;
				border: none;
				border-radius: 3px;
				cursor: pointer;
				color: white;
			}
			.delete-btn {
				background: #dc3545;
			}
			.download-btn {
				background: #28a745;
			}
			.action-btn:hover {
				opacity: 0.9;
			}
		</style>
	</head>
	<body>
		<div class="login-box" id="loginBox">
			<h2>Вход для администратора</h2>
			<input
				type="text"
				id="adminPhone"
				placeholder="Введите телефон администратора"
				style="width: 100%; padding: 10px"
			/>
			<button
				onclick="loadAdminData()"
				style="margin-top: 10px; padding: 10px 20px"
			>
				Войти
			</button>
			<p id="errorMsg" style="color: red"></p>
		</div>

		<div id="adminPanel" style="display: none">
			<h2>Оценки пользователей</h2>
			<table id="evalTable">
				<thead>
					<tr>
						<th>Имя</th>
						<th>Телефон</th>
						<th>Продукт</th>
						<th>Оценка</th>
						<th>Дата</th>
						<th>Действия</th>
					</tr>
				</thead>
				<tbody></tbody>
			</table>

			<!-- Таблица пользователей -->
			<h2>Пользователи</h2>
			<table id="users-table" border="1" style="margin-bottom: 30px;">
				<thead>
					<tr>
						<th>ID</th>
						<th>Имя</th>
						<th>Телефон</th>
						<th>Админ</th>
						<th>Дата регистрации</th>
						<th>Действия</th>
					</tr>
				</thead>
				<tbody id="users-tbody">
					<!-- Пользователи будут подгружены сюда -->
				</tbody>
			</table>
		</div>

		<script>
			let adminPhone = '';

			async function loadAdminData() {
				adminPhone = document.getElementById('adminPhone').value.trim()
				const error = document.getElementById('errorMsg')
				error.textContent = ''

				if (!adminPhone) {
					error.textContent = 'Введите номер телефона'
					return
				}

				try {
					console.log('Attempting to login with phone:', adminPhone)
					const res = await fetch('/api/admin/evaluations', {
						method: 'GET',
						headers: {
							'adminToken': adminPhone,
							'Accept': 'application/json'
						}
					})

					console.log('Response status:', res.status)
					const data = await res.json()
					console.log('Response data:', data)

					if (!data.success) {
						error.textContent = data.error || 'Ошибка входа'
						return
					}

					// Сохраняем токен админа
					localStorage.setItem('adminToken', adminPhone);

					document.getElementById('loginBox').style.display = 'none'
					document.getElementById('adminPanel').style.display = 'block'

					const tbody = document.querySelector('#evalTable tbody')
					tbody.innerHTML = '' // Clear existing rows
					data.evaluations.forEach(e => {
						const tr = document.createElement('tr')
						tr.innerHTML = `
							<td>${e.User.username}</td>
							<td>${e.User.phone}</td>
							<td>${e.productName}</td>
							<td>${e.overallRating}/5</td>
							<td>${new Date(e.createdAt).toLocaleString()}</td>
							<td>
								<button class="action-btn download-btn" onclick="downloadReport(${e.id})">Скачать</button>
								<button class="action-btn delete-btn" onclick="deleteEvaluation(${e.id})">Удалить</button>
							</td>
						`
						tbody.appendChild(tr)
					})
				} catch (err) {
					console.error('Error during admin login:', err)
					error.textContent = 'Ошибка при попытке входа: ' + err.message
				}
			}

			async function deleteEvaluation(id) {
				if (!confirm('Вы уверены, что хотите удалить этот отзыв?')) {
					return;
				}

				try {
					const res = await fetch(`/api/admin/evaluations/${id}`, {
						method: 'DELETE',
						headers: {
							'adminToken': adminPhone,
							'Accept': 'application/json'
						}
					});

					const data = await res.json();
					if (data.success) {
						// Reload the table
						loadAdminData();
					} else {
						alert('Ошибка при удалении: ' + data.error);
					}
				} catch (err) {
					console.error('Error deleting evaluation:', err);
					alert('Ошибка при удалении отзыва');
				}
			}

			async function downloadReport(id) {
				try {
					const res = await fetch(`/api/admin/evaluations/${id}/report`, {
						headers: {
							'adminToken': adminPhone
						}
					});

					if (!res.ok) {
						throw new Error('Failed to download report');
					}

					const blob = await res.blob();
					const url = window.URL.createObjectURL(blob);
					const a = document.createElement('a');
					a.href = url;
					a.download = `evaluation-${id}.txt`;
					document.body.appendChild(a);
					a.click();
					window.URL.revokeObjectURL(url);
					document.body.removeChild(a);
				} catch (err) {
					console.error('Error downloading report:', err);
					alert('Ошибка при скачивании отчета');
				}
			}

			// Получить и отобразить пользователей
			async function loadUsers() {
				const token = localStorage.getItem('adminToken');
				const res = await fetch('/api/admin/users', {
					headers: { 'adminToken': token }
				});
				const data = await res.json();
				if (data.success) {
					const tbody = document.getElementById('users-tbody');
					tbody.innerHTML = '';
					data.users.forEach(user => {
						const tr = document.createElement('tr');
						tr.innerHTML = `
							<td>${user.id}</td>
							<td>${user.username}</td>
							<td>${user.phone}</td>
							<td>${user.isAdmin ? 'Да' : 'Нет'}</td>
							<td>${new Date(user.createdAt).toLocaleString()}</td>
							<td>
								<button onclick="setAdmin('${user.phone}', ${!user.isAdmin})">${user.isAdmin ? 'Снять админа' : 'Назначить админом'}</button>
								<button onclick="deleteUser(${user.id})" style="color:red;">Удалить</button>
							</td>
						`;
						tbody.appendChild(tr);
					});
				}
			}

			// Назначить/снять админа
			async function setAdmin(phone, isAdmin) {
				const token = localStorage.getItem('adminToken');
				const res = await fetch('/api/admin/set-admin', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
						'adminToken': token
					},
					body: JSON.stringify({ phone, isAdmin })
				});
				const data = await res.json();
				alert(data.message || data.error);
				loadUsers();
			}

			// Удалить пользователя
			async function deleteUser(id) {
				if (!confirm('Удалить пользователя и все его отзывы?')) return;
				const token = localStorage.getItem('adminToken');
				const res = await fetch(`/api/admin/users/${id}`, {
					method: 'DELETE',
					headers: { 'adminToken': token }
				});
				const data = await res.json();
				alert(data.message || data.error);
				loadUsers();
			}

			// При загрузке страницы подгружаем пользователей
			window.addEventListener('DOMContentLoaded', () => {
				loadUsers();
			});
		</script>
	</body>
</html>
