<!DOCTYPE html>
<html lang="ru">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Админ-панель - Бетон-30</title>
		<link rel="stylesheet" href="css/admin.css">
		<script src="/socket.io/socket.io.js"></script>
		<script src="js/admin.js"></script>
		<style>
			body {
				font-family: sans-serif;
				background: #f4f4f4;
				padding: 30px;
			}
			.login-box {
				background: white;
				padding: 20px;
				max-width: 400px;
				margin: 50px auto;
				border-radius: 10px;
				box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
			}
			table {
				width: 100%;
				border-collapse: collapse;
				margin-top: 30px;
				background: white;
				box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
			}
			th,
			td {
				padding: 10px;
				border: 1px solid #ccc;
				text-align: left;
			}
			th {
				background: #333;
				color: white;
			}
			h2 {
				margin-bottom: 20px;
			}
			.action-btn {
				padding: 5px 10px;
				margin: 0 5px;
				border: none;
				border-radius: 3px;
				cursor: pointer;
				color: white;
			}
			.delete-btn {
				background: #dc3545;
			}
			.download-btn {
				background: #28a745;
			}
			.action-btn:hover {
				opacity: 0.9;
			}
		</style>
	</head>
	<body>
		<div class="admin-container">
			<header class="admin-header">
				<h1>Админ-панель</h1>
				<div class="admin-stats">
					<div class="stat-item">
						<span class="stat-label">Пользователей:</span>
						<span id="users-count" class="stat-value">0</span>
					</div>
					<div class="stat-item">
						<span class="stat-label">Оценок:</span>
						<span id="evaluations-count" class="stat-value">0</span>
					</div>
				</div>
			</header>

			<main class="admin-content">
				<section class="admin-section">
					<h2>Последние действия</h2>
					<div id="admin-logs" class="logs-container">
						<!-- Logs will be added here dynamically -->
					</div>
				</section>

				<section class="admin-section">
					<h2>Пользователи</h2>
					<div id="users-list" class="users-container">
						<!-- Users will be added here dynamically -->
					</div>
				</section>

				<section class="admin-section">
					<h2>Оценки</h2>
					<div id="evaluations-list" class="evaluations-container">
						<!-- Evaluations will be added here dynamically -->
					</div>
				</section>

				<section class="admin-section">
					<h2>Продукты</h2>
					<div id="products-list" class="products-container">
						<!-- Products will be added here dynamically -->
					</div>
					<div class="add-product-form">
						<input type="text" id="new-product-name" placeholder="Название продукта">
						<button onclick="addProduct()">Добавить продукт</button>
					</div>
				</section>
			</main>
		</div>

		<div class="login-box" id="loginBox">
			<h2>Вход для администратора</h2>
			<input
				type="text"
				id="adminPhone"
				placeholder="Введите телефон администратора"
				style="width: 100%; padding: 10px"
			/>
			<button
				onclick="loadAdminData()"
				style="margin-top: 10px; padding: 10px 20px"
			>
				Войти
			</button>
			<p id="errorMsg" style="color: red"></p>
		</div>

		<div id="adminPanel" style="display: none">
			<h2>Оценки пользователей</h2>
			<table id="evalTable">
				<thead>
					<tr>
						<th>Имя</th>
						<th>Телефон</th>
						<th>Продукт</th>
						<th>Оценка</th>
						<th>Дата</th>
						<th>Действия</th>
					</tr>
				</thead>
				<tbody></tbody>
			</table>

			<!-- Таблица пользователей -->
			<h2>Пользователи</h2>
			<table id="users-table" border="1" style="margin-bottom: 30px;">
				<thead>
					<tr>
						<th>ID</th>
						<th>Имя</th>
						<th>Телефон</th>
						<th>Админ</th>
						<th>Дата регистрации</th>
						<th>Действия</th>
					</tr>
				</thead>
				<tbody id="users-tbody">
					<!-- Пользователи будут подгружены сюда -->
				</tbody>
			</table>

			<!-- Блок статистики -->
			<div id="statsBox" style="background:#fff;padding:20px;margin-bottom:30px;border-radius:10px;box-shadow:0 0 10px #0001;max-width:900px;margin:auto;">
				<h2>Статистика</h2>
				<div id="statsContent">Загрузка...</div>
			</div>

			<!-- Кнопки экспорта -->
			<div style="margin-bottom:30px;text-align:center;">
				<button onclick="exportEvaluations()" class="action-btn download-btn">Скачать все отзывы (CSV)</button>
				<button onclick="exportUsers()" class="action-btn download-btn">Скачать всех пользователей (CSV)</button>
			</div>

			<!-- Управление продуктами -->
			<div id="productsBox" style="background:#fff;padding:20px;margin-bottom:30px;border-radius:10px;box-shadow:0 0 10px #0001;max-width:900px;margin:auto;">
				<h2>Управление продуктами</h2>
				<ul id="productsList"></ul>
				<input type="text" id="newProductName" placeholder="Новый продукт" style="padding:5px;">
				<button onclick="addProduct()">Добавить</button>
			</div>

			<!-- Логи действий -->
			<div id="logsBox" style="background:#fff;padding:20px;margin-bottom:30px;border-radius:10px;box-shadow:0 0 10px #0001;max-width:900px;margin:auto;">
				<h2>Логи действий</h2>
				<ul id="logsList" style="max-height:200px;overflow:auto;"></ul>
			</div>
		</div>

		<script>
			let adminPhone = '';

			async function loadAdminData() {
				adminPhone = document.getElementById('adminPhone').value.trim()
				const error = document.getElementById('errorMsg')
				error.textContent = ''

				if (!adminPhone) {
					error.textContent = 'Введите номер телефона'
					return
				}

				try {
					console.log('Attempting to login with phone:', adminPhone)
					const res = await fetch('/api/admin/evaluations', {
						method: 'GET',
						headers: {
							'adminToken': adminPhone,
							'Accept': 'application/json'
						}
					})

					console.log('Response status:', res.status)
					const data = await res.json()
					console.log('Response data:', data)

					if (!data.success) {
						error.textContent = data.error || 'Ошибка входа'
						return
					}

					// Сохраняем токен админа
					localStorage.setItem('adminToken', adminPhone);

					document.getElementById('loginBox').style.display = 'none'
					document.getElementById('adminPanel').style.display = 'block'

					const tbody = document.querySelector('#evalTable tbody')
					tbody.innerHTML = '' // Clear existing rows
					data.evaluations.forEach(e => {
						const tr = document.createElement('tr')
						tr.innerHTML = `
							<td>${e.User.username}</td>
							<td>${e.User.phone}</td>
							<td>${e.productName}</td>
							<td>${e.overallRating}/5</td>
							<td>${new Date(e.createdAt).toLocaleString()}</td>
							<td>
								<button class="action-btn download-btn" onclick="downloadReport(${e.id})">Скачать</button>
								<button class="action-btn delete-btn" onclick="deleteEvaluation(${e.id})">Удалить</button>
							</td>
						`
						tbody.appendChild(tr)
					})
				} catch (err) {
					console.error('Error during admin login:', err)
					error.textContent = 'Ошибка при попытке входа: ' + err.message
				}
			}

			async function deleteEvaluation(id) {
				if (!confirm('Вы уверены, что хотите удалить этот отзыв?')) {
					return;
				}

				try {
					const res = await fetch(`/api/admin/evaluations/${id}`, {
						method: 'DELETE',
						headers: {
							'adminToken': adminPhone,
							'Accept': 'application/json'
						}
					});

					const data = await res.json();
					if (data.success) {
						// Reload the table
						loadAdminData();
					} else {
						alert('Ошибка при удалении: ' + data.error);
					}
				} catch (err) {
					console.error('Error deleting evaluation:', err);
					alert('Ошибка при удалении отзыва');
				}
			}

			async function downloadReport(id) {
				try {
					const res = await fetch(`/api/admin/evaluations/${id}/report`, {
						headers: {
							'adminToken': adminPhone,
							'Accept': 'text/plain, application/json'
						}
					});

					if (!res.ok) {
						const errorData = await res.json().catch(() => null);
						throw new Error(errorData?.error || `Failed to download report: ${res.status} ${res.statusText}`);
					}

					// Get the content type from the response
					const contentType = res.headers.get('content-type');
					
					if (contentType?.includes('application/json')) {
						// If it's JSON, it might be an error message
						const data = await res.json();
						if (data.error) {
							throw new Error(data.error);
						}
					}

					const blob = await res.blob();
					const url = window.URL.createObjectURL(blob);
					const a = document.createElement('a');
					a.href = url;
					a.download = `evaluation-${id}-${new Date().toISOString().split('T')[0]}.txt`;
					document.body.appendChild(a);
					a.click();
					window.URL.revokeObjectURL(url);
					document.body.removeChild(a);
				} catch (err) {
					console.error('Error downloading report:', err);
					alert('Ошибка при скачивании отчета: ' + err.message);
				}
			}

			// Получить и отобразить пользователей
			async function loadUsers() {
				const token = localStorage.getItem('adminToken');
				const res = await fetch('/api/admin/users', {
					headers: { 'adminToken': token }
				});
				const data = await res.json();
				if (data.success) {
					const tbody = document.getElementById('users-tbody');
					tbody.innerHTML = '';
					data.users.forEach(user => {
						const tr = document.createElement('tr');
						tr.innerHTML = `
							<td>${user.id}</td>
							<td>${user.username}</td>
							<td>${user.phone}</td>
							<td>${user.isAdmin ? 'Да' : 'Нет'}</td>
							<td>${new Date(user.createdAt).toLocaleString()}</td>
							<td>
								<button onclick="setAdmin('${user.phone}', ${!user.isAdmin})">${user.isAdmin ? 'Снять админа' : 'Назначить админом'}</button>
								<button onclick="editUserPrompt(${user.id}, '${user.username}', '${user.phone}')">✏️</button>
								<button onclick="deleteUser(${user.id})" style="color:red;">Удалить</button>
							</td>
						`;
						tbody.appendChild(tr);
					});
				}
			}

			// Назначить/снять админа
			async function setAdmin(phone, isAdmin) {
				const token = localStorage.getItem('adminToken');
				const res = await fetch('/api/admin/set-admin', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
						'adminToken': token
					},
					body: JSON.stringify({ phone, isAdmin })
				});
				const data = await res.json();
				alert(data.message || data.error);
				loadUsers();
			}

			// Удалить пользователя
			async function deleteUser(id) {
				if (!confirm('Удалить пользователя и все его отзывы?')) return;
				const token = localStorage.getItem('adminToken');
				const res = await fetch(`/api/admin/users/${id}`, {
					method: 'DELETE',
					headers: { 'adminToken': token }
				});
				const data = await res.json();
				alert(data.message || data.error);
				loadUsers();
			}

			// --- СТАТИСТИКА ---
			async function loadStats() {
				const token = localStorage.getItem('adminToken');
				const res = await fetch('/api/admin/statistics', { headers: { 'adminToken': token } });
				const data = await res.json();
				if (data.success) {
					let html = `<b>Пользователей:</b> ${data.usersCount} &nbsp; <b>Админов:</b> ${data.adminsCount} &nbsp; <b>Всего отзывов:</b> ${data.evalCount}<br><br>`;
					html += '<table border="1" style="width:100%;margin-top:10px;"><tr><th>Продукт</th><th>Кол-во отзывов</th><th>Средняя оценка</th></tr>';
					data.productsStats.forEach(p => {
						html += `<tr><td>${p.product}</td><td>${p.count}</td><td>${p.avgRating ?? '-'}</td></tr>`;
					});
					html += '</table>';
					document.getElementById('statsContent').innerHTML = html;
				} else {
					document.getElementById('statsContent').textContent = 'Ошибка загрузки статистики';
				}
			}

			// --- ЭКСПОРТ ---
			function exportEvaluations() {
				const token = localStorage.getItem('adminToken');
				window.open('/api/admin/export/evaluations?adminToken=' + encodeURIComponent(token), '_blank');
			}
			function exportUsers() {
				const token = localStorage.getItem('adminToken');
				window.open('/api/admin/export/users?adminToken=' + encodeURIComponent(token), '_blank');
			}

			// --- ПРОДУКТЫ ---
			async function loadProducts() {
				const token = localStorage.getItem('adminToken');
				const res = await fetch('/api/admin/products', { headers: { 'adminToken': token } });
				const data = await res.json();
				if (data.success) {
					const ul = document.getElementById('productsList');
					ul.innerHTML = '';
					data.products.forEach(name => {
						const li = document.createElement('li');
						li.innerHTML = `<span>${name}</span> <button onclick="editProductPrompt('${name}')">✏️</button> <button onclick="deleteProduct('${name}')" style="color:red;">Удалить</button>`;
						ul.appendChild(li);
					});
				}
			}
			async function addProduct() {
				const name = document.getElementById('newProductName').value.trim();
				if (!name) return alert('Введите название продукта');
				const token = localStorage.getItem('adminToken');
				const res = await fetch('/api/admin/products', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json', 'adminToken': token },
					body: JSON.stringify({ name })
				});
				const data = await res.json();
				if (data.success) {
					document.getElementById('newProductName').value = '';
					loadProducts();
				} else {
					alert(data.error);
				}
			}
			async function deleteProduct(name) {
				if (!confirm('Удалить продукт?')) return;
				const token = localStorage.getItem('adminToken');
				const res = await fetch('/api/admin/products', {
					method: 'DELETE',
					headers: { 'Content-Type': 'application/json', 'adminToken': token },
					body: JSON.stringify({ name })
				});
				const data = await res.json();
				if (data.success) loadProducts(); else alert(data.error);
			}
			function editProductPrompt(oldName) {
				const newName = prompt('Новое название продукта:', oldName);
				if (!newName || newName === oldName) return;
				editProduct(oldName, newName);
			}
			async function editProduct(oldName, newName) {
				const token = localStorage.getItem('adminToken');
				const res = await fetch('/api/admin/products', {
					method: 'PUT',
					headers: { 'Content-Type': 'application/json', 'adminToken': token },
					body: JSON.stringify({ oldName, newName })
				});
				const data = await res.json();
				if (data.success) loadProducts(); else alert(data.error);
			}

			// --- ЛОГИ ---
			async function loadLogs() {
				const token = localStorage.getItem('adminToken');
				const res = await fetch('/api/admin/logs', { headers: { 'adminToken': token } });
				const data = await res.json();
				if (data.success) {
					const ul = document.getElementById('logsList');
					ul.innerHTML = '';
					data.logs.slice().reverse().forEach(log => {
						const li = document.createElement('li');
						li.textContent = `[${new Date(log.time).toLocaleString()}] ${log.adminPhone}: ${log.action} ${JSON.stringify(log.details)}`;
						ul.appendChild(li);
					});
				}
			}

			// --- РЕДАКТИРОВАНИЕ ПОЛЬЗОВАТЕЛЯ ---
			async function editUserPrompt(id, username, phone) {
				const newUsername = prompt('Новое имя пользователя:', username);
				const newPhone = prompt('Новый телефон:', phone);
				if (!newUsername && !newPhone) return;
				await editUser(id, newUsername, newPhone);
			}
			async function editUser(id, username, phone) {
				const token = localStorage.getItem('adminToken');
				const res = await fetch(`/api/admin/users/${id}`, {
					method: 'PUT',
					headers: { 'Content-Type': 'application/json', 'adminToken': token },
					body: JSON.stringify({ username, phone })
				});
				const data = await res.json();
				if (data.success) loadUsers(); else alert(data.error);
			}

			// При загрузке страницы подгружаем пользователей
			window.addEventListener('DOMContentLoaded', () => {
				loadStats();
				loadProducts();
				loadLogs();
				loadUsers();
			});
		</script>
	</body>
</html>
